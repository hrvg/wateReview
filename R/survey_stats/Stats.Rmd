---
title: "WMLAC Survey Stats"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r warning = FALSE, include = TRUE, message = FALSE, results = "asis"}

#### library ####
library(ggplot2)
library(reshape2)
library(dplyr)

#### function definitions ####
read_survey_df <- function(fname = "Water Management in Latin America_edit.csv"){
  df <- read.csv(file.path(fname))
  df <- df[-(1:2),] # remove rows with just text
  # edit column names
  df <- df %>% rename(Lat = LocationLatitude, Lon = LocationLongitude, Position = Q1, Affiliation = Q2, Years = Q4, Discipline = Q14, Country_current = Q5, Country_current_other = Q5_46_TEXT, Country_born = Q6, Country_born_other = Q6_47_TEXT, Country_research = Q8, Country_research_other = Q8_46_TEXT, Publications = Q11, Journals = Q12, Journal_motivation = Q15, Funding = Q13, Interdisc_interest = Q16_1, Interdisc_level = Q16_2, Equal_resource_distribution = Q17_1, Sufficient_climate_funds = Q17_2, Future_contact = Q18, Comments = Q16, Comments_translation = Comments.translation)
  # change variable types
  df$Lat <- as.numeric(levels(df$Lat))[df$Lat]
  df$Lon <- as.numeric(levels(df$Lon))[df$Lon]
  df$Years <- as.numeric(levels(df$Years))[df$Years]
  df$Publications <- as.numeric(levels(df$Publications))[df$Publications]
  return(df)
}

filter_columns <- function(df, colname_list = c("Country_current", "Years")){df[, colnames(df) %in% colname_list]}

filter_by_country <- function(.df = df, country = "Brazil", country_type = "Country_current"){.df[.df[[country_type]]==country, ]}

melt_df_country <- function(df_country, country_type = "Country_current"){
  df_country <- df_country[, colnames(df_country) != country_type]
  column_names <- colnames(df_country)
  l.df_country <- lapply(seq(ncol(df_country)), function(j) data.frame(variable = rep(column_names[j], nrow(df_country)), value = as.character(df_country[, j])))
  df_country <- do.call(rbind, l.df_country)
  return(df_country)
}

plot_df_country <- function(df_country, title_text = "Brazil" ){
  df_country_fact <- df_country[!df_country$variable %in% c("Years", "Publications"), ]
  df_country_num <- df_country[df_country$variable %in% c("Years", "Publications"), ]
  if(nrow(df_country_fact) > 1){
    p_factor <- ggplot(df_country_fact, aes(x = value)) +
    theme_minimal() +
    geom_bar() +
    coord_flip() +
    labs(title = title_text) +
    facet_wrap(variable ~ ., scales = "free", ncol = 2)
    print(p_factor)
  }
  if (nrow(df_country_num) > 1){
    df_country_num$value <- as.numeric(df_country_num$value)
    p_numeric <- ggplot(df_country_num, aes(x = value)) +
    theme_minimal() +
    geom_histogram() +
    coord_flip() +
    labs(title = title_text) +
    facet_wrap(variable ~ ., scales = "free", ncol = 2)
    print(p_numeric)
  } 
}

get_countries <- function(df, country_type = "Country_current"){as.character(sort(unique(df[[country_type]])))}

#### main ####
df <- read_survey_df()
df <- filter_columns(df, colname_list = c("Position", "Affiliation", "Years", "Discipline", "Country_current", "Publications", "Journals", "Funding"))
countries <- get_countries(df)

for (country in countries) {
    cat('\n')
    cat(paste0("#", country, "\n"))
    df_country <- filter_by_country(country = country)
    df_country <- melt_df_country(df_country)
    plot_df_country(df_country, title_text = country)
    cat('\n')
}
```