---
title: "Diversity"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Diversity}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```
setwd("~/R_code/LAC")
source("./diversity/lib_lac.R")

################### libraries #########################
library(dplyr)
library(vegan)
library(broom)
library(reshape2)
library(ggpubr)
library(data.table)
library(wesanderson)
library(ggplot2)
library(philentropy)
library(scales)
library(ggplotify)
library(plotly)
library(tidyr)
library(tidyverse)
library(ggrepel)

################### raw files #########################
general <- readRDS("./consolidated_results_NSF_general.Rds")
specific <- readRDS("./consolidated_results_NSF_specific.Rds") # 45 themes
methods <- readRDS("./consolidated_results_methods.Rds")
budget <- readRDS("./consolidated_results_water budget.Rds")
theme <- readRDS("./consolidated_results_theme.Rds")


# final CSV finals that reflect new country predictions are saved as "....2"

```

```

# calculate diversity by paper / for all of LAC
clean <- remove_year_country(specific) #  specify which (species group)
diversity_LA <- diversity_LAC(clean)
diversity_paper <- diversity(clean)

# check - diveristy function from vegan package works
# check <- as.data.frame(colSums(clean))
# sum <- sum(check)
# check$pi <- check$`colSums(clean)`/sum
# check$lnpi <- log(check$pi)
# check$pilnpi <- check$pi * check$lnpi
# H <- -sum(check$pilnpi)

################### analysis #########################

# calculate diversity by country
general2 <- diversity_country_2(general)
specific2 <- diversity_country_2(specific)
budget2 <- diversity_country_2(budget)



diversity_by_country<-cbind(general2, specific2, budget2)
diversity_by_country <- diversity_by_country %>%
  select(-c("country1","country2")) %>%
  rename(NSFgeneral = x, NSFspecific = x1, budget = x2)

# SAVE
# write.csv(diversity_by_country, file = "./diversity/csvs/diversity2.csv")

################### graphs #########################

diversity_by_country_graph <- melt(diversity_by_country, 
                                   id.vars = c("country"))

# NSF specific  
specific_graphdf <- subset(diversity_by_country_graph, variable == "NSFspecific")
specific_graph <- ggdotchart(specific_graphdf, x = "country", y = "value", #add color = cluster
                             add = "segments", sorting = "descending", rotate = TRUE, 
                             ylab = "Entropy across specific topics",
                             xlab = "Country")

specific_graph

# NSF general  
general_graphdf <- subset(diversity_by_country_graph, variable == "NSFgeneral")
general_graph <- ggdotchart(general_graphdf, x = "country", y = "value", #add color = cluster
                            add = "segments", sorting = "descending", rotate = TRUE,
                            ylab = "Entropy across general topics",
                            xlab = "Country")
# budget
budget_graphdf <- subset(diversity_by_country_graph, variable == "budget")
budget_graph <- ggdotchart(budget_graphdf, x = "country", y = "value", #add color = cluster
                             add = "segments", sorting = "descending", rotate = TRUE,
                           ylab = "Entropy across water budget topics",
                           xlab = "Country")

specific_graph
general_graph
budget_graph


ggdotchart(diversity_by_country_graph, x = "country", y = "value", color = "variable",
           rotate = TRUE)

ggplot(diversity_by_country,aes(NSFgeneral,NSFspecific, label = country)) +
  geom_text_repel() +
  geom_point() +
  theme_pubr() +
  labs(x = "General topics",y = "Specific topics", title = "Country entropy")
```