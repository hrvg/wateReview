---
title: "Normality"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Normality}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: bibliography.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.height = 6,
  fig.width = 6, 
  comment = "#>"
)
```

# Purpose

In this vignette, we derive the _normality_ of four categories of topics.
Normality from the Jensen-Shannon distance, $d_{JS}$, [@Endres2003], defined as the square-root of the Jensen-Shannon divergence, $D_{JS}$, [@Lin1991]:

\[D_{JS}(N,Q) = \frac{1}{2} \lbrack D_{KL}(N,R) + D_{KL}(P,R) \rbrack \] 

with $N,P$, probability distributions, $R = \frac{1}{2} (N+P)$ the midpoint probability and $D_{KL}$, the Kullback-Leibler divergence [@Kullback1951].
Here, we take $N = \mathcal{N}(0,1)$, the standard normal distribution with mean $\mu = 0$ and standard deviation $\sigma = 1$.
As $d_{JS} = 0$ when $P = \mathcal{N}(0,1)$, to better meet the intuition of normality, we define normality as:

\[ \textrm{Normality} = 1 - d_{JS} \]

so that normality is closer to 1 when the $P$ is closer to the standard normal distribution.

For a given topic, normality is defined for two types of distributions $P$, forming the two axis of subsequent graphs:

1. the probability distribution of the percentage of research devoted to the topic across countries;
1. the probability distribution of topic probabilities across documents.

# Data loading

We access the consolidated results stored in `extdata` using `system.file()`.

```{r}
general <- readRDS(system.file(
    "extdata",
    "consolidated_results_NSF_general.Rds",
    package = "wateReview")
)
specific <- readRDS(system.file(
    "extdata",
    "consolidated_results_NSF_specific.Rds",
    package = "wateReview")
)
methods <- readRDS(system.file(
    "extdata",
    "consolidated_results_methods.Rds",
    package = "wateReview")
)
budget <- readRDS(system.file(
    "extdata",
    "consolidated_results_water budget.Rds",
    package = "wateReview")
)
theme <- readRDS(system.file(
    "extdata",
    "consolidated_results_theme.Rds",
    package = "wateReview")
)
```

# Deriving normality

First, we select the countries with at least 30 documents to keep the stastitics tidy.

```{r libraries}
library(wateReview)
library(magrittr)
```

First, we calculate the normality across countries with:

```{r}
probs <- reduce_docs_for_JSd(general) # PARAMETER HERE, CHANGE THIS TO A LOOP
head(probs)
country_distance <- get_country_distance(probs)
head(country_distance)
topic_distance <- get_topic_distance(probs)
head(topic_distance)
distance <- merge(country_distance, topic_distance, by = "topic")
```


```
################### pseudocode #########################
# subset main df to countries with > 30 papers
# rescale value
# graph density distribution of corpus data + a normal distribution
# extract info both graphs - compare "y"s
# calculate distance - sqrt of JSD

################### code #########################

# define subset
# probs <- probs %>% mutate(topic = replace(topic, topic == "groundwater flow", "groundwater"))

############### across countries ###########

# calculate distance from normal for % of research done in each country



# graphs for guide
# reservoir <- get_JSd_country('reservoirs', plot = T)
# rivers <- get_JSd_country('rivers', plot = T)
# get_JSd_country('irrigation', plot = T) 

############### across documents ###########

# calculate distance from normal for all documents
# MEDIAN OF JSD for EACH topic by 12 COUNTRIES




# combine and save separate csvs
distance <- merge(country_distance, topic_distance, by = "topic")

#write.csv(distance, file = "./diversity/csvs/themedistance.csv")
```

```
budget <- read.csv("./data/waterbudgetdistance.csv") 
methods <- read.csv("./data/methodsdistance.csv") 
theme <- read.csv("./data/themedistance.csv")
general <- read.csv("./data/generaldistance.csv")
specific <- read.csv("./data/specificdistance.csv")


######## methods #########
methods.base <- ggplot(methods,aes(topic_distance,country_distance, label = topic)) +
  geom_text_repel() +
  geom_point() +
  theme_pubr() +
  labs(x = "Normality across documents",y = "Normality across countries")

methods.edit <- 
  methods.base +
  #grids() +
  coord_fixed() +
  ylim(0.5,0.93) +
  xlim(0.26,0.67) +
  coord_fixed() +
  labs(title = "Research methods")

######## budget #########
budget.base <- ggplot(budget,aes(topic_distance,country_distance, label = topic)) +
  geom_text_repel() +
  geom_point() +
  theme_pubr() +
  labs(x = "Normality across documents",y = "Normality across countries")

budget.edit <- 
  budget.base +
  ylim(0.5,0.93) +
  xlim(0.26,0.67) +
  coord_fixed() +
  labs(title = "Components of water budget")

######## themes ##########
ggscatter(theme, y = "country_distance", x = "topic_distance",
                    label = "topic",
                    label.rectangle = TRUE,
                    repel = TRUE,
                    xlab = "Normality across documents",
                    ylab = "Normality across countries") 

themes.base <- ggplot(theme,aes(topic_distance,country_distance, label = topic)) +
  geom_text_repel() +
  geom_point() +
  theme_pubr() +
  labs(x = "Normality across documents",y = "Normality across countries")

themes.edit <- 
  themes.base +
  #grids() +
  coord_fixed() +
  labs(title = "Themes")


######## general ##########
general.base <- ggplot(general,aes(topic_distance,country_distance, label = topic)) +
  geom_text_repel() +
  geom_point() +
  theme_pubr() +
  labs(x = "Normality across documents",y = "Normality across countries")

general.edit <- 
  general.base +
  #grids() +
  coord_fixed() +
  labs(title = "General topics")

######## specific ##########
ggscatter(specific, y = "country_distance", x = "topic_distance",
         label = "topic",
         label.rectangle = TRUE,
         repel = TRUE,
         xlab = "Normality across documents",
         ylab = "Normality across countries") 

specific.base <- ggplot(specific,aes(topic_distance,country_distance, label = topic)) +
  geom_text_repel() +
  geom_point() +
  theme_pubr() +
  labs(x = "Normality across documents",y = "Normality across countries")

specific.edit <- 
  specific.base +
  coord_fixed() +
  labs(title = "Specific  topics")





######## interactie graph ######## 

b <- ggplot(theme, aes(y = country_distance, x = topic_distance, group = topic)) + geom_point() + theme_pubr()
ggplotly(b, tooltip = c('topic'))


######## topics for guide to normality ######## 
reservoir.edit <- 
  reservoir +
  rremove("legend") +
  clean_theme() +
  labs(title = "Far from normal")

rivers.edit <-
  rivers +
  rremove("legend") +
  ylim(0,0.8) +
  clean_theme() +
  labs(title = "Close to normal")


######## saving individual pieces ##########

methods.edit
budget.edit
# reservoir.edit
# rivers.edit
themes.edit
general.edit
specific.edit
```

# References